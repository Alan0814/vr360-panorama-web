var PSV_Config={photoUrls:{front:"",back:"",top:"",bottom:"",left:"",right:""},sizeIsOk:{front:false,back:false,top:false,bottom:false,left:false,right:false},PSV_type:720};var PHOTO_TYPE={SINGLE_PHOTO:"single",FRONT_PHOTO:"front",BACK_PHOTO:"back",LEFT_PHOTO:"left",RIGHT_PHOTO:"right",TOP_PHOTO:"top",BOTTOM_PHOTO:"bottom",SOLA_PHOTO:"sola",COMBINATION_PHOTO:"combination"};$().ready(function(){$("#frontContainer").click(function(){$("#chooseFileFront").click()});$("#backContainer").click(function(){$("#chooseFileBack").click()});$("#leftContainer").click(function(){$("#chooseFileLeft").click()});$("#rightContainer").click(function(){$("#chooseFileRight").click()});$("#topContainer").click(function(){$("#chooseFileTop").click()});$("#bottomContainer").click(function(){$("#chooseFileBottom").click()});if(getCookie("vr360_user_token")==null){$("#user_status").text("未登录");$("#user_action").html("<a href='javascript:showLoginBox();'>登录</a>")}else{getUserStatus()}});$(function(){showImg("frontContainer","chooseFileFront","frontInfoContainer","front");showImg("backContainer","chooseFileBack","backInfoContainer","back");showImg("topContainer","chooseFileTop","topInfoContainer","top");showImg("bottomContainer","chooseFileBottom","bottomInfoContainer","bottom");showImg("leftContainer","chooseFileLeft","leftInfoContainer","left");showImg("rightContainer","chooseFileRight","rightInfoContainer","right")});var photoMsg={photoType:"",pageType:""};function showImg(a,d,c,b){$("#"+d).change(function(j){var g=$("#"+d).get(0).files[0];var k=new Date(g.lastModifiedDate);var i=k.getFullYear()+"-"+(k.getMonth()+1)+"-"+k.getDate()+" "+k.getHours()+":"+k.getMinutes();$("#"+c+" .photoInfo_name").text("图片:"+g.name);$("#"+c+" .photoInfo_size").text("大小:"+(g.size/(1024*1024)).toFixed(2)+"M");$("#"+c+" .photoInfo_time").text("上次修改:"+i);var h;var f=new FileReader();f.readAsDataURL(g);f.onload=function(m){h=m.target.result;var l=new Image();l.onload=function(){var o=l.width;var e=l.height;var p=gcd(o,e);$("#"+c+" .photoInfo_status").text("长宽比 "+o/p+":"+e/p)};l.src=h;switch(b){case"front":PSV_Config.photoUrls.front=h;if(g.size<=1048576){PSV_Config.sizeIsOk.front=true}else{PSV_Config.sizeIsOk.front=false}break;case"back":PSV_Config.photoUrls.back=h;if(g.size<=1048576){PSV_Config.sizeIsOk.back=true}else{PSV_Config.sizeIsOk.back=false}break;case"top":PSV_Config.photoUrls.top=h;if(g.size<=1048576){PSV_Config.sizeIsOk.top=true}else{PSV_Config.sizeIsOk.top=false}break;case"bottom":PSV_Config.photoUrls.bottom=h;if(g.size<=1048576){PSV_Config.sizeIsOk.bottom=true}else{PSV_Config.sizeIsOk.bottom=false}break;case"left":PSV_Config.photoUrls.left=h;if(g.size<=1048576){PSV_Config.sizeIsOk.left=true}else{PSV_Config.sizeIsOk.left=false}break;case"right":PSV_Config.photoUrls.right=h;if(g.size<=1048576){PSV_Config.sizeIsOk.right=true}else{PSV_Config.sizeIsOk.right=false}break}$("#"+a+" .img-choose").css("display","none");$("#"+a+" .img-show").get(0).src=h;$("#"+a+" .img-show").css("display","block")}})}function gcd(d,c){if(d%c){return gcd(c,d%c)}else{return c}}function createVrPhoto(){if(PSV_Config.photoUrls.front==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张前景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(PSV_Config.photoUrls.back==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张后景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(PSV_Config.photoUrls.left==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张左景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(PSV_Config.photoUrls.right==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张右景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(PSV_Config.photoUrls.top==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张上景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(PSV_Config.photoUrls.bottom==""){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请选择一张下景图片。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{PSV_Config.PSV_type=$("input[name='photoType']:checked").val();createPSV()}}}}}}}function uploadVrPhoto(){var g=$("#vrPhotoDes").val();var a=PSV_Config.sizeIsOk.front;var f=PSV_Config.sizeIsOk.back;var d=PSV_Config.sizeIsOk.left;var e=PSV_Config.sizeIsOk.right;var b=PSV_Config.sizeIsOk.top;var c=PSV_Config.sizeIsOk.bottom;if(filterSqlStr(g)){$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 请不要输入*、>、<、\'、-、+、/、#及与sql相关的敏感字符\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}else{if(a&&f&&d&&e&&b&&c){$.confirm({title:"VR 360提示您",content:"确认上传图片?",type:"green",icon:"glyphicon glyphicon-question-sign",animation:"RotateX",buttons:{ok:{text:"确认",btnClass:"btn-primary",action:function(){var h=JSON.parse(getCookie("vr360_user_token"));if(h==null){$.alert("请先登录！")}else{if(h.token!=""&&h.token!=null){$("#myChooseModal").modal("show");setTimeout(function(){uploadInfo(g)},1500)}else{$("#bg-mask").css("display","none");$("#msgModal").fadeOut();$.alert("请先登录！")}}}},cancel:{text:"取消",btnClass:"btn-primary"}}})}else{$("#msg-container").append('<div class="alert alert-danger fade in" role="alert" id="sizeWrong" >\n                <strong>错误!</strong> 图片不符合要求，请检查图片大小、格式以及是否上传完整。\n            </div>');setTimeout(function(){$(".alert").alert("close")},5000)}}}function uploadFile(b,d){var e=false;var c=$("#"+d)[0];var a=new FormData(c);a.append("photoType",b);$.ajax({type:"post",url:URL_TYPE.NONPUBLIC_PREFIX+"/uploadFile",headers:{token:JSON.parse(getCookie("vr360_user_token")).token},data:a,async:false,cache:false,processData:false,contentType:false,timeout:600000,success:function(f){if(f.code==0){e=f.data}else{if(f.code==2){e=-1}}},error:function(f){console.log(f)}});return e}function uploadInfo(f){var b=uploadFile(PHOTO_TYPE.FRONT_PHOTO,"uploadFileFormFront");if(b==-1){$.alert("登录已失效，请重新登录")}else{var e=uploadFile(PHOTO_TYPE.BACK_PHOTO,"uploadFileFormBack");var c=uploadFile(PHOTO_TYPE.LEFT_PHOTO,"uploadFileFormLeft");var i=uploadFile(PHOTO_TYPE.RIGHT_PHOTO,"uploadFileFormRight");var h=uploadFile(PHOTO_TYPE.TOP_PHOTO,"uploadFileFormTop");var a=uploadFile(PHOTO_TYPE.BOTTOM_PHOTO,"uploadFileFormBottom");if(b!=false&&e!=false&&c!=false&&i!=false&&h!=false&&a!=false){var g={photoType:PHOTO_TYPE.SOLA_PHOTO,photoDeg:PSV_Config.PSV_type};var d=[b,e,c,i,h,a];$.ajax({url:URL_TYPE.NONPUBLIC_PREFIX+"/uploadVrInfo",type:"post",data:{vrPhotoParam:JSON.stringify(g),photoIds:JSON.stringify(d),vrPhotoType:PHOTO_TYPE.COMBINATION_PHOTO,vrPhotoDes:f},headers:{token:JSON.parse(getCookie("vr360_user_token")).token},dataType:"json",success:function(j){$("#myChooseModal").modal("hide");if(j.code==0){$.confirm({title:"VR 360提示您",content:"恭喜您，上传成功！图片正在审核中，在此之前仅由您本人能浏览该全景。",type:"green",animation:"RotateX",buttons:{ok:{text:"确认",btnClass:"btn-primary",action:function(){location.href="panorama.html?id="+j.data}}}})}else{$.alert("未知错误，上传失败！")}},error:function(j){console.log(j);$("#myChooseModal").modal("hide");$.alert("未知错误，上传失败！")}})}else{$("#myChooseModal").modal("hide");$.alert("上传失败！")}}}function createPSV(){var c;var d=document.getElementById("PSV_demo_container");$("#PSV_demo_container").empty();var b=window.screen.width;var a="500px";if(PSV_Config.PSV_type==360){c=new PhotoSphereViewer({panorama:PSV_Config.photoUrls,default_fov:179,container:d,time_anim:false,anim_speed:"0.6rpm",navbar:["gyroscope","caption","fullscreen"],usexmpdata:false,size:{width:"100%",height:a},gyroscope:true,latitude_range:[Math.PI/3,-Math.PI/3],tilt_down_max:Math.PI/2,tilt_up_max:Math.PI/2})}else{if(PSV_Config.PSV_type==720){c=new PhotoSphereViewer({panorama:PSV_Config.photoUrls,default_fov:179,container:d,time_anim:false,anim_speed:"0.6rpm",navbar:["gyroscope","caption","fullscreen"],usexmpdata:false,size:{width:"100%",height:a},gyroscope:true})}}c.on("panorama-loaded",function(){if(b<=789){var e=document.querySelector(".psv-gyroscope-button");var f=new MouseEvent("click",{cancelable:true,bubble:true,view:window});e.dispatchEvent(f)}else{c.startAutorotate()}})}function filterSqlStr(d){var c=sql_str().split(",");var a=false;for(var b=0;b<c.length;b++){if(d.toLowerCase().indexOf(c[b])!=-1){a=true;break}}return a}function sql_str(){var a="and,delete,or,exec,insert,select,union,update,count,*,>,<,',-,+,/,#";return a}console.log("欢迎使用VR 360全景\n小本网站还请大神勿黑，手下留情呀~~\n如有什么疑问请联系\nQQ：1246886075\nvr.beifengtz.com");