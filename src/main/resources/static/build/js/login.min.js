var action;var URL_TYPE={API_VERSION:"/v1",NONPUBLIC_PREFIX:"/v1/nonpub",PUB_PREFIX:"/v1/pub"};var addressInfo={};$(function(){if(!Modernizr.canvas||!Modernizr.webgl||!Modernizr.eventlistener){alert("经检测您的浏览器版本过低，请升级浏览器后浏览。")}if(!Modernizr.cssanimations||!Modernizr.fullscreen){console.log("系统提示：经检测您的浏览器版本较低，部分功能不完整，可能会影响您的浏览体验")}getUserStatus();$("#loginPhone,#loginPassword").keydown(function(){if(event.keyCode=="13"){login()}});addVisitLog()});function addVisitLog(){getIpAddress();var a=location.pathname;$.ajax({url:URL_TYPE.PUB_PREFIX+"/visitLog",type:"get",data:{page:a,ip:ip},dataType:"json",success:function(b){addressInfo=b.data;if(location.pathname.indexOf("statistics")!=-1){renderAddress()}},error:function(b){console.log(b.status)}})}function getUserStatus(){try{var a=JSON.parse(getCookie("vr360_user_token"));if(a==null){delCookie("vr360_user_token");$("#user_status").text("未登录");$("#user_action").html("<a href='javascript:showLoginBox();'>登录</a>")}else{if(a.token!=""&&a.token!=null){$("#user_status").text(a.username);$("#user_action").html("<a href='javascript:logout();'>退出登录</a>")}else{delCookie("vr360_user_token");$("#user_status").text("未登录");$("#user_action").html("<a href='javascript:showLoginBox();'>登录</a>")}}}catch(b){delCookie("vr360_user_token");$("#user_status").text("未登录");$("#user_action").html("<a href='javascript:showLoginBox();'>登录</a>")}}function showLoginBox(){$(".login-container,#bg-mask").fadeIn(500)}function hideLoginBox(){$(".login-container,#bg-mask").fadeOut(500)}function logout(){$.confirm({title:"确认",content:"确认退出登录?",type:"green",icon:"glyphicon glyphicon-question-sign",buttons:{ok:{text:"确认",btnClass:"btn-primary",action:function(){delCookie("vr360_user_token");$("#user_status").text("未登录");$("#user_action").html("<a href='javascript:showLoginBox();'>登录</a>");if(location.href.indexOf("people.html")==-1){location.href=location.href.split("?")[0]}else{location.href=location.href}}},cancel:{text:"取消",btnClass:"btn-primary"}}})}function goLogin(){$("#loginAndRegister").html('<div align="center" >\n                    <h2>欢迎登录VR360</h2>\n                </div>\n                <form>\n                    <div class="form-group">\n                        <label for="loginPhone">手机号</label>\n                        <input type="number" class="form-control" id="loginPhone" placeholder="输入你的手机号">\n                    </div>\n                    <div class="form-group">\n                        <label for="loginPassword">密码</label>\n                        <input type="password" class="form-control" id="loginPassword" placeholder="输入你的密码">\n                    </div>\n                    <nav aria-label="...">\n                        <ul class="pager" >\n                            <li class="previous"><a href="#" style="color: #FA9856">找回密码</a></li>\n                            <li class="next"><a href="javascript:goRegister();" style="color: #FA9856">去注册 </a></li>\n                        </ul>\n                    </nav>\n                    <div align="center">\n                        <button type="submit" class="btn btn-default" style="width: 100%;background-color: #FA9856;color:white;">登录</button>\n                    </div>\n                </form>')}function goRegister(){$("#loginAndRegister").html('<div align="center" >\n                    <h2>欢迎注册VR360</h2>\n                </div>\n                <div class="form-group">\n                    <label for="loginPhone">手机号</label>\n                    <input type="number" class="form-control" id="registerPhone" placeholder="输入你的手机号">\n                </div>\n                <div class="form-group">\n                    <label for="loginPassword">密码</label>\n                    <input type="password" class="form-control" id="registerPassword" placeholder="输入你的密码">\n                </div>\n                <div class="form-group">\n                    <label for="loginPassword">通信令牌</label><small>(获取手机验证码使用)</small>\n                    <div class="col-xs-12 col-sm12 col-md-12">\n                        <div class="col-xs-6 col-sm6 col-md-6" style="padding: 0">\n                            <input type="text" id="code_input" class="form-control" placeholder="请输入验证码"/>\n                        </div>\n                        <div class="col-xs-6 col-sm6 col-md-6" id="v_container" style="height: 30px;"></div>\n                    </div>\n                </div>\n                <div class="form-group" style="margin-top: 45px;">\n                    <label for="loginPassword">手机验证</label>\n                    <div class="col-xs-12 col-sm12 col-md-12" style="margin-top: 5px;">\n                        <div class="col-xs-6 col-sm6 col-md-6" style="padding: 0">\n                            <input type="text" id="phone_code_input" class="form-control" placeholder="请输入手机验证码"/>\n                        </div>\n                        <div class="col-xs-6 col-sm6 col-md-6">\n                            <button type="submit" class="btn btn-default"  id="getPhoneCodeBtn" onclick="getPhoneSMS()">获取手机验证码&nbsp;<span id="daojishi"></span></button>\n                        </div>\n                    </div>\n                </div>\n                <nav aria-label="...">\n                    <ul class="pager" >\n                        <li class="next"><a href="javascript:goLogin();" style="color: #FA9856">去登录 </a></li>\n                    </ul>\n                </nav>\n                <div align="center">\n                    <button class="btn btn-default" style="width: 100%;background-color: #FA9856;color:white;" onclick=\'register()\' id="registerBtn">注册</button>\n                </div>');window.clearInterval(action);$("#daojishi").text("");getVerificationCode();$("#v_container").click(function(){$("#v_container").empty();getVerificationCode()})}function getVerificationCode(){$.ajax({type:"get",contentType:"application/x-www-form-urlencoded; charset=utf-8",url:URL_TYPE.PUB_PREFIX+"/getVerificationCode",dataType:"json",beforeSend:function(){},success:function(a){var b=new aesUtil();var c=new GVerify("v_container",b.decrypt(a.data))},error:function(a){console.log(a)}})}function getPhoneSMS(){var c=$("#code_input").val();var b=$("#registerPhone").val();if(b==""||b.length!=11){$("#msgModal").text("请输入正确的手机号码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{if(c==""||c==null||c.length<4){$("#msgModal").text("请输入规范的验证码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{$("#getPhoneCodeBtn").attr("disabled","disabed");var a=60;action=self.setInterval(function(){$("#daojishi").text(a);a--;if(a==0){window.clearInterval(action);$("#daojishi").text("");$("#getPhoneCodeBtn").removeAttr("disabled")}},1000);$.ajax({type:"post",url:URL_TYPE.PUB_PREFIX+"/sendSMS",data:{phoneNumber:b,verificationCode:c},dataType:"json",beforeSend:function(){},success:function(d){if(d.code==12){$("#msgModal").text("验证码错误");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000);window.clearInterval(action);$("#daojishi").text("");$("#getPhoneCodeBtn").removeAttr("disabled")}},error:function(d){console.log(d)}})}}}function login(){var c=new md5Util();var b=$("#loginPhone").val();var a=$("#loginPassword").val();if(b.length!=11){$("#msgModal").text("请输入正确的手机号码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{if(a.length<6){$("#msgModal").text("请输入不低于6位的密码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{$.ajax({type:"post",url:URL_TYPE.PUB_PREFIX+"/loginByPhone",data:{phoneNumber:b,password:c.hex_md5(c.hex_md5(a))},dataType:"json",success:function(d){if(d.code!=0){$("#msgModal").text("账号或密码错误");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{setCookie("vr360_user_token",JSON.stringify(d.data),"h1");getUserStatus();hideLoginBox();if(location.pathname.indexOf("personpage.html")!=-1){location.href=location.href.split("?")[0]}else{location.href=location.href}}},error:function(d){console.log(d);$("#msgModal").text("登录失败");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}})}}}function register(){var b=new md5Util();var d=$("#registerPhone").val();var a=$("#registerPassword").val();var c=$("#phone_code_input").val();if(d==""||d.length!=11){$("#msgModal").text("请输入规范的手机号码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{if(a==""||a.length<6){$("#msgModal").text("请输入不小于6位的密码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{if(c==""){$("#msgModal").text("请输入正确的手机验证码");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}else{$.ajax({type:"post",url:URL_TYPE.PUB_PREFIX+"/register",data:{authenticationType:3,authenticationId:d,autograph:b.hex_md5(b.hex_md5(a)),code:c},dataType:"json",success:function(e){if(e.code==0){setCookie("vr360_user_token",JSON.stringify(e.data),"h1");getUserStatus();hideLoginBox()}else{$("#msgModal").text("注册失败");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}},error:function(e){console.log(e);$("#msgModal").text("注册失败");$("#msgModal").fadeIn();setTimeout(function(){$("#msgModal").fadeOut()},2000)}})}}}}function setCookie(a,c,d){var b=getsec(d);var e=new Date();e.setTime(e.getTime()+b*1);document.cookie=a+"="+escape(c)+";expires="+e.toGMTString()}function getsec(c){var b=c.substring(1,c.length)*1;var a=c.substring(0,1);if(a=="s"){return b*1000}else{if(a=="h"){return b*60*60*1000}else{if(a=="d"){return b*24*60*60*1000}}}}function getCookie(b){var a,c=new RegExp("(^| )"+b+"=([^;]*)(;|$)");if(a=document.cookie.match(c)){return unescape(a[2])}else{return null}}function delCookie(a){var c=new Date();c.setTime(c.getTime()-1);var b=getCookie(a);if(b!=null){document.cookie=a+"="+b+";expires="+c.toGMTString()}};